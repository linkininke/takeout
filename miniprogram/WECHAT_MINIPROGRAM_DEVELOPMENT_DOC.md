# 苍穹外卖微信小程序功能开发书

## 1. 项目概述

苍穹外卖是一款基于微信小程序的外卖点餐平台，旨在为用户提供便捷、高效的在线点餐服务。本开发书详细描述了微信小程序端的功能设计、页面结构、API接口和实现逻辑。

## 2. 功能模块设计

### 2.1 用户管理

#### 2.1.1 微信授权登录

**功能描述**：实现微信小程序的授权登录功能，获取用户的微信基本信息并完成用户注册/登录流程。

**页面设计**：
- 登录页面（`pages/index/index`）：显示欢迎界面和授权登录按钮

**API接口**：
- `POST /auth/wx-login`：微信授权登录接口
  - 请求参数：`code`（微信登录临时凭证）
  - 返回数据：`token`（JWT令牌）、`customer`（用户信息）

**实现逻辑**：
1. 用户点击授权登录按钮
2. 调用微信API `wx.login()` 获取临时登录凭证code
3. 将code发送到后端服务器
4. 后端通过微信接口获取openid，查询或创建用户
5. 后端返回JWT令牌和用户信息
6. 小程序存储令牌，完成登录

#### 2.1.2 个人信息管理

**功能描述**：允许用户查看和修改个人基本信息。

**页面设计**：
- 个人中心页面（`pages/user/user`）：显示用户头像、昵称、手机号等信息
- 编辑个人信息页面（待开发）：允许用户修改头像、昵称等

**API接口**：
- `GET /customer/info`：获取用户信息
- `PUT /customer/info`：更新用户信息

**实现逻辑**：
1. 从本地存储获取token
2. 携带token请求用户信息
3. 显示用户信息
4. 用户修改信息后，发送更新请求
5. 更新本地存储的用户信息

#### 2.1.3 地址管理

**功能描述**：允许用户管理收货地址，包括添加、编辑、删除和设置默认地址。

**页面设计**：
- 地址列表页面（待开发）：显示所有收货地址
- 编辑地址页面（待开发）：添加或修改收货地址

**API接口**：
- `GET /address-book/list`：获取地址列表
- `POST /address-book`：添加地址
- `PUT /address-book`：更新地址
- `DELETE /address-book/{id}`：删除地址
- `PUT /address-book/default`：设置默认地址

**实现逻辑**：
1. 从本地存储获取token
2. 请求地址列表数据
3. 显示地址列表，支持添加、编辑、删除操作
4. 设置默认地址时，发送请求并更新本地缓存

### 2.2 点餐功能

#### 2.2.1 店铺列表与搜索

**功能描述**：显示附近店铺列表，支持按名称、分类等条件搜索。

**页面设计**：
- 首页（`pages/index/index`）：显示推荐店铺和搜索框
- 店铺列表页面（`pages/shop/shop`）：显示所有店铺，支持筛选和搜索

**API接口**：
- `GET /shop/list`：获取店铺列表
  - 请求参数：`keyword`（搜索关键词）、`category`（店铺分类）、`page`（页码）、`size`（每页数量）
- `GET /shop/categories`：获取店铺分类

**实现逻辑**：
1. 请求店铺列表数据
2. 支持下拉刷新和上拉加载更多
3. 实现搜索功能，根据关键词过滤店铺
4. 实现分类筛选功能

#### 2.2.2 菜品浏览与分类筛选

**功能描述**：进入店铺后，显示店铺内的菜品列表，支持按菜品分类筛选。

**页面设计**：
- 店铺详情页面（`pages/shop/shop-detail`）：显示店铺信息、菜品分类和菜品列表

**API接口**：
- `GET /shop/{id}`：获取店铺详情
- `GET /dish/list`：获取菜品列表
  - 请求参数：`shopId`（店铺ID）、`categoryId`（菜品分类ID）
- `GET /dish/category/{shopId}`：获取菜品分类

**实现逻辑**：
1. 根据店铺ID请求店铺详情
2. 请求菜品分类数据
3. 请求对应分类的菜品数据
4. 支持切换分类查看不同菜品
5. 支持菜品搜索功能

#### 2.2.3 购物车管理

**功能描述**：允许用户将菜品加入购物车，修改数量，删除商品等。

**页面设计**：
- 购物车页面（`pages/cart/cart`）：显示购物车商品列表，支持修改数量、删除商品、清空购物车

**API接口**：
- `POST /shopping-cart`：添加商品到购物车
- `GET /shopping-cart/list`：获取购物车列表
- `PUT /shopping-cart`：更新购物车商品数量
- `DELETE /shopping-cart/{id}`：删除购物车商品
- `DELETE /shopping-cart/clear`：清空购物车

**实现逻辑**：
1. 从本地存储获取token
2. 请求购物车数据
3. 显示购物车商品列表
4. 支持修改商品数量、删除商品、清空购物车
5. 实时计算购物车总价

#### 2.2.4 订单提交

**功能描述**：用户确认购物车商品后，提交订单并选择支付方式。

**页面设计**：
- 订单确认页面（`pages/order/confirm`）：显示订单信息、收货地址、支付方式等

**API接口**：
- `POST /orders`：提交订单
- `GET /address-book/default`：获取默认地址

**实现逻辑**：
1. 从购物车获取商品列表
2. 获取默认收货地址
3. 显示订单信息，包括商品列表、总价、配送费等
4. 用户确认后，提交订单请求
5. 跳转到支付页面

### 2.3 订单管理

#### 2.3.1 订单列表与详情

**功能描述**：显示用户的所有订单，支持按订单状态筛选，并可查看订单详情。

**页面设计**：
- 订单列表页面（`pages/order/order`）：显示所有订单，支持按状态筛选
- 订单详情页面（待开发）：显示订单的详细信息，包括商品列表、支付信息、配送信息等

**API接口**：
- `GET /orders/list`：获取订单列表
  - 请求参数：`status`（订单状态）、`page`（页码）、`size`（每页数量）
- `GET /orders/{id}`：获取订单详情

**实现逻辑**：
1. 从本地存储获取token
2. 请求订单列表数据
3. 支持按订单状态筛选
4. 点击订单进入详情页面
5. 请求订单详情数据并显示

#### 2.3.2 订单支付（微信支付）

**功能描述**：实现微信支付功能，支持用户在线支付订单。

**页面设计**：
- 支付页面（待开发）：显示支付金额和支付方式，调用微信支付API

**API接口**：
- `POST /payment/create`：创建支付订单
- `GET /payment/query`：查询支付状态

**实现逻辑**：
1. 从本地存储获取token
2. 调用支付创建接口，获取微信支付参数
3. 调用微信支付API `wx.requestPayment()`
4. 处理支付结果回调
5. 更新订单状态

#### 2.3.3 订单评价

**功能描述**：允许用户对已完成的订单进行评价，包括评分和文字评价。

**页面设计**：
- 订单评价页面（待开发）：显示订单商品列表，支持评分和文字评价

**API接口**：
- `POST /order-comment`：提交订单评价

**实现逻辑**：
1. 从本地存储获取token
2. 显示待评价订单商品列表
3. 用户输入评分和评价内容
4. 提交评价请求
5. 更新订单状态为已评价

#### 2.3.4 退款申请

**功能描述**：允许用户对已支付的订单申请退款。

**页面设计**：
- 退款申请页面（待开发）：显示订单信息，支持填写退款原因

**API接口**：
- `POST /refund-application`：提交退款申请
- `GET /refund-application/{id}`：获取退款申请详情

**实现逻辑**：
1. 从本地存储获取token
2. 显示订单信息和退款规则
3. 用户填写退款原因并提交申请
4. 更新订单状态为退款中
5. 退款结果通知用户

### 2.4 其他功能

#### 2.4.1 优惠券领取与使用

**功能描述**：允许用户领取优惠券，并在下单时使用优惠券抵扣金额。

**页面设计**：
- 优惠券列表页面（待开发）：显示可领取和已拥有的优惠券
- 优惠券详情页面（待开发）：显示优惠券的详细信息和使用规则

**API接口**：
- `GET /coupon/list`：获取可领取优惠券列表
- `POST /coupon-record/receive`：领取优惠券
- `GET /coupon-record/list`：获取已拥有优惠券列表
- `GET /coupon-record/available`：获取可用优惠券列表

**实现逻辑**：
1. 从本地存储获取token
2. 请求可领取优惠券列表
3. 用户点击领取，调用领取接口
4. 下单时，显示可用优惠券列表
5. 用户选择优惠券，计算优惠后金额

#### 2.4.2 积分商城

**功能描述**：实现积分商城功能，允许用户使用积分兑换商品。

**页面设计**：
- 积分商城首页（待开发）：显示积分余额和可兑换商品
- 商品详情页面（待开发）：显示商品详情和兑换规则
- 兑换记录页面（待开发）：显示积分兑换记录

**API接口**：
- `GET /point`：获取积分余额
- `GET /point-mall-item/list`：获取积分商城商品列表
- `POST /point-exchange-record`：积分兑换商品
- `GET /point-exchange-record/list`：获取积分兑换记录

**实现逻辑**：
1. 从本地存储获取token
2. 请求积分余额和可兑换商品列表
3. 用户选择商品，调用兑换接口
4. 扣除积分，生成兑换记录
5. 显示兑换结果

#### 2.4.3 消息通知

**功能描述**：实现消息通知功能，包括订单状态更新、活动通知等。

**页面设计**：
- 消息列表页面（待开发）：显示所有消息
- 消息详情页面（待开发）：显示消息的详细内容

**API接口**：
- `GET /message/list`：获取消息列表
- `GET /message/{id}`：获取消息详情
- `PUT /message/read`：标记消息为已读

**实现逻辑**：
1. 从本地存储获取token
2. 请求消息列表数据
3. 显示消息列表，支持标记已读
4. 点击消息进入详情页面
5. 支持下拉刷新获取最新消息

## 3. 页面结构设计

### 3.1 底部导航栏（TabBar）

| 页面名称 | 页面路径 | 图标 | 功能描述 |
|---------|---------|------|---------|
| 首页 | `pages/index/index` | 首页图标 | 显示推荐店铺和搜索入口 |
| 店铺 | `pages/shop/shop` | 店铺图标 | 显示所有店铺列表 |
| 购物车 | `pages/cart/cart` | 购物车图标 | 显示购物车商品 |
| 订单 | `pages/order/order` | 订单图标 | 显示订单列表 |
| 我的 | `pages/user/user` | 个人中心图标 | 显示个人信息和功能入口 |

### 3.2 页面层级关系

```
├── 首页（index）
│   └── 店铺列表页（shop）
│       └── 店铺详情页（shop-detail）
│           └── 购物车页（cart）
│               └── 订单确认页（confirm）
│                   └── 支付页（待开发）
├── 订单列表页（order）
│   └── 订单详情页（待开发）
│       ├── 订单评价页（待开发）
│       └── 退款申请页（待开发）
└── 个人中心页（user）
    ├── 个人信息编辑页（待开发）
    ├── 地址管理页（待开发）
    ├── 优惠券页（待开发）
    ├── 积分商城页（待开发）
    └── 消息中心页（待开发）
```

## 4. 技术实现方案

### 4.1 前端技术栈

- 微信小程序原生开发
- WXML + WXSS + JavaScript
- 微信小程序API

### 4.2 后端技术栈

- Spring Boot
- MyBatis Plus
- MySQL
- JWT认证
- 微信支付API

### 4.3 数据存储

- 本地存储：使用微信小程序的`wx.setStorageSync()`和`wx.getStorageSync()`存储用户信息、token等
- 后端数据库：MySQL数据库存储用户信息、订单数据、商品数据等

### 4.4 网络请求

- 使用微信小程序的`wx.request()`API发送网络请求
- 统一的API请求封装，处理请求拦截、响应拦截、错误处理等
- API基础URL配置在`config/api.js`中，支持开发环境和生产环境切换

## 5. 开发计划

### 5.1 第一阶段：核心功能开发

1. 微信授权登录功能
2. 店铺列表与搜索功能
3. 菜品浏览与分类筛选功能
4. 购物车管理功能
5. 订单提交功能

### 5.2 第二阶段：订单管理功能开发

1. 订单列表与详情功能
2. 订单支付功能
3. 订单评价功能
4. 退款申请功能

### 5.3 第三阶段：用户管理功能开发

1. 个人信息管理功能
2. 地址管理功能

### 5.4 第四阶段：其他功能开发

1. 优惠券领取与使用功能
2. 积分商城功能
3. 消息通知功能

## 6. 测试计划

### 6.1 功能测试

- 测试每个功能模块的正常流程
- 测试异常情况的处理
- 测试边界条件

### 6.2 性能测试

- 测试页面加载速度
- 测试网络请求响应时间
- 测试大量数据的处理能力

### 6.3 兼容性测试

- 测试不同微信版本的兼容性
- 测试不同手机型号的兼容性
- 测试不同网络环境的兼容性

### 6.4 安全性测试

- 测试用户数据的安全性
- 测试支付功能的安全性
- 测试API接口的安全性

## 7. 上线计划

1. 完成所有功能开发和测试
2. 提交微信小程序审核
3. 审核通过后，发布正式版本
4. 持续监控和优化小程序性能
5. 根据用户反馈，迭代更新功能

## 8. 维护计划

1. 定期检查和修复bug
2. 优化小程序性能
3. 更新微信API适配
4. 添加新功能和优化现有功能
5. 定期备份数据

---

本开发书详细描述了苍穹外卖微信小程序的功能设计和实现方案，为开发团队提供了清晰的开发指导。在开发过程中，应严格按照本开发书的要求进行实现，并根据实际情况进行适当调整。